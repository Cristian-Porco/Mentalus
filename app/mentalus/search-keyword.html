<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Ricerca per Parola Chiave - Mentalus</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-7xl mx-auto py-10 px-6">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-3xl font-bold text-gray-800">Mentalus</h2>
      <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Logout</button>
    </div>

    <div class="mb-6 flex items-center gap-4">
      <input id="keywordInput" type="text" placeholder="Inserisci parola chiave"
             class="flex-grow p-3 border rounded-md focus:outline-none focus:ring focus:ring-blue-300" />
      <button onclick="handleSearch()" class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition">
        Cerca
      </button>
    </div>

    <div class="flex gap-6">
      <!-- Lista paragrafi -->
      <div class="w-1/3 bg-white p-4 rounded shadow overflow-y-auto max-h-[70vh]">
        <h2 class="text-xl font-semibold mb-3">Risultati</h2>
        <ul id="resultsList" class="space-y-2 text-sm text-gray-700">
          <li class="text-gray-400 italic">Nessuna ricerca effettuata.</li>
        </ul>
      </div>

      <!-- Testo generato -->
      <div class="w-2/3 bg-white p-6 rounded shadow">
        <h2 class="text-xl font-semibold mb-3">Testo generato</h2>
        <div id="generatedText" class="prose max-w-none text-gray-800 whitespace-pre-wrap"></div>
      </div>
    </div>
  </div>

  <script>
    async function handleSearch() {
      const keyword = document.getElementById("keywordInput").value.trim();
      if (!keyword) return alert("Inserisci una parola chiave valida.");

      // Mostra caricamento
      document.getElementById("resultsList").innerHTML = `<li class="text-gray-500 italic">Caricamento risultati...</li>`;
      document.getElementById("generatedText").innerHTML = `<p class="animate-pulse text-gray-500">Generazione del testo in corso...</p>`;

      try {
        const res = await fetch(`/keywords.php?action=search&query=${encodeURIComponent(keyword)}`, {
          credentials: 'include'
        });
        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
          document.getElementById("resultsList").innerHTML = `<li class="text-gray-500 italic">Nessun risultato trovato.</li>`;
          document.getElementById("generatedText").innerHTML = '';
          return;
        }

        renderResults(data);
        generateTextWithAI(data);

      } catch (err) {
        console.error(err);
        document.getElementById("resultsList").innerHTML = `<li class="text-red-500 italic">Errore durante la ricerca.</li>`;
        document.getElementById("generatedText").innerHTML = '';
      }
    }

    function renderResults(results) {
      const container = document.getElementById("resultsList");
      container.innerHTML = "";

      results.forEach(r => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${r.sheet_title}</strong>: ${r.descrizione}`;
        container.appendChild(li);
      });
    }

    async function generateTextWithAI(paragraphs) {
      const descrizioni = paragraphs.map(item => item.descrizione).join('\n\n');

      try {
        const res = await fetch('/ai_generate.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ input: descrizioni })
        });

        const data = await res.json();
        document.getElementById("generatedText").innerHTML = data.text || '<p class="text-gray-400 italic">Nessun testo generato.</p>';
      } catch (err) {
        console.error(err);
        document.getElementById("generatedText").innerHTML = '<p class="text-red-500 italic">Errore nella generazione AI.</p>';
      }
    }
  </script>
</body>
</html>