<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Foglio | Mentalus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
  <style>
    html, body { height: 100%; overflow: hidden; } /* disabilita scroll pagina: scorre solo il main */
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0,'wght' 400,'GRAD' 0,'opsz' 24;
    }
  </style>
</head>
<body class="bg-slate-900 text-slate-100">

  <!-- App layout: header fisso + main scrollabile -->
  <div class="min-h-screen grid grid-rows-[auto,1fr] overflow-hidden">

    <!-- Navbar -->
    <header class="row-start-1 row-end-2 sticky top-0 z-30 bg-slate-900/80 backdrop-blur border-b border-slate-800">
      <div class="max-w-7xl mx-auto px-4 py-3">
        <div class="flex items-center justify-between">
          <a href="/app/mentalus/dashboard" class="flex items-center gap-2">
            <span class="text-2xl font-extrabold tracking-tight">Mentalus</span>
          </a>

          <nav class="hidden md:flex items-center gap-3">
            <a href="/app/mentalus/dashboard" class="px-3 py-2 rounded-lg hover:bg-slate-800 border border-slate-700">Dashboard</a>
            <a href="/app/mentalus/dashboard/search-keyword" class="px-3 py-2 rounded-lg hover:bg-slate-800 border border-slate-700">Cerca parole chiave</a>
            <button onclick="logout()"
              class="px-3 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">Logout</button>
          </nav>

          <button id="menuBtn" class="md:hidden px-3 py-2 rounded-lg hover:bg-slate-800 border border-slate-700" aria-label="Apri menu">
            ☰
          </button>
        </div>
        <!-- Mobile menu -->
        <div id="mobileMenu" class="md:hidden hidden pt-2 pb-3 space-y-1">
          <a href="/app/mentalus/dashboard" class="block px-3 py-2 rounded-lg hover:bg-slate-800 border border-slate-700">Dashboard</a>
          <a href="/app/mentalus/dashboard/search-keyword" class="block px-3 py-2 rounded-lg bg-slate-800 border border-slate-700">Cerca parole chiave</a>
          <button onclick="logout()" class="w-full text-left px-3 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">Logout</button>
        </div>
      </div>
    </header>

    <!-- Contenuto: unico contenitore scrollabile -->
    <main class="row-start-2 row-end-3 overflow-y-auto">
      <div class="max-w-7xl mx-auto px-4">
        <!-- Barra sticky interna al main -->
        <div class="sticky top-0 z-10 bg-slate-900/70 backdrop-blur pb-3 pt-6">
          <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
            <div class="flex-1">
              <input id="sheetTitle" type="text"
                class="text-3xl font-bold text-slate-100 bg-transparent focus:outline-none w-full"
                value="Titolo del foglio..." />
              <p id="sheetDate" class="text-sm text-slate-400 mt-1">Data creazione...</p>
            </div>

            <div class="flex items-center gap-2">
              <button id="boldBtn" title="Grassetto" class="px-3 py-2 rounded-lg hover:bg-slate-800 border border-slate-700" type="button">
                <span class="material-symbols-outlined">format_bold</span>
              </button>
              <button id="italicBtn" title="Corsivo" class="px-3 py-2 rounded-lg hover:bg-slate-800 border border-slate-700" type="button">
                <span class="material-symbols-outlined">format_italic</span>
              </button>
              <a href="/app/mentalus/dashboard" class="px-3 py-2 rounded-lg border border-slate-700 hover:bg-slate-800">← Dashboard</a>
            </div>
          </div>
        </div>

        <ul id="paragraphList" class="space-y-4 mb-6 mt-4"></ul>

        <form id="paragraphForm" class="mb-10">
          <textarea name="descrizione" id="descrizioneInput" rows="3"
            placeholder="Scrivi un nuovo paragrafo e premi Invio"
            required
            class="w-full p-3 bg-slate-800 border border-slate-700 rounded-lg text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-400 resize-none"></textarea>
        </form>
      </div>
    </main>
  </div>

  <!-- Loader a schermo intero -->
  <div id="pageLoader"
       class="fixed inset-0 z-[999] hidden bg-slate-900/80 backdrop-blur-sm flex items-center justify-center">
    <div class="flex flex-col items-center gap-4">
      <div class="h-10 w-10 rounded-full border-4 border-slate-600 border-t-white animate-spin" aria-hidden="true"></div>
      <p class="text-slate-200 text-sm" role="status" aria-live="polite">Caricamento…</p>
    </div>
  </div>

  <script>
    // Mobile menu
    document.getElementById("menuBtn")?.addEventListener("click", () => {
      document.getElementById("mobileMenu")?.classList.toggle("hidden");
    });

    const params = new URLSearchParams(window.location.search);
    const sheetId = params.get('id');
    const paragraphList = document.getElementById('paragraphList');
    const sheetTitle = document.getElementById('sheetTitle');
    const sheetDate = document.getElementById('sheetDate');

    // Loader helpers (reference counting)
    const pageLoaderEl = document.getElementById('pageLoader');
    let __pendingOps = 0;

    function startLoading() {
      __pendingOps++;
      pageLoaderEl.classList.remove('hidden');
    }
    function stopLoading() {
      __pendingOps = Math.max(0, __pendingOps - 1);
      if (__pendingOps === 0) pageLoaderEl.classList.add('hidden');
    }
    function withLoader(promiseOrFn) {
      startLoading();
      try {
        const p = typeof promiseOrFn === 'function' ? promiseOrFn() : promiseOrFn;
        return Promise.resolve(p).finally(stopLoading);
      } catch (e) {
        stopLoading();
        throw e;
      }
    }

    async function logout() {
      await fetch('/app/mentalus/api/logout.php', { credentials: 'include' });
      window.location.href = "/app/mentalus/";
    }

    if (!sheetId) {
      alert("Nessun ID specificato");
      window.location.href = "/app/mentalus/dashboard";
    }

    // ---- Caricamento titolo foglio (con auth check + loader)
    async function loadSheetTitle() {
      startLoading();
      try {
        const res = await fetch(`/app/mentalus/api/text_sheets.php?action=view&id=${sheetId}`, { credentials: 'include' });

        if (res.status === 401) { await logout(); return; }
        if (res.status === 403 || res.status === 404) {
          alert("Accesso negato o foglio non trovato");
          window.location.href = "/app/mentalus/dashboard";
          return;
        }

        const data = await res.json();
        sheetTitle.value = data.titolo;
        document.title = data.titolo + " | Mentalus";
        const date = new Date(data.data_creazione);
        sheetDate.textContent = `Creato il ${date.toLocaleDateString()} alle ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
      } catch (err) {
        console.error("Errore caricamento titolo:", err);
        alert("Errore di connessione al server.");
      } finally {
        stopLoading();
      }
    }

    // Aggiornamento titolo (debounced) — opzionale sotto loader
    sheetTitle.addEventListener('input', debounce(async function () {
      const form = new FormData();
      form.append('id', sheetId);
      form.append('titolo', sheetTitle.value);

      await withLoader(fetch('/app/mentalus/api/text_sheets.php?action=edit', {
        method: 'POST',
        credentials: 'include',
        body: form
      }));

      document.title = sheetTitle.value + " | Mentalus";
    }, 200));

    // ---- Caricamento paragrafi (con auth check + loader)
    async function loadParagraphs() {
      startLoading();
      try {
        let res;
        try {
          res = await fetch(
            `/app/mentalus/api/paragraphs.php?action=view&sheet_id=${encodeURIComponent(sheetId)}`,
            { credentials: 'include' }
          );
        } catch (err) {
          console.error("Errore di rete:", err);
          alert("Errore di connessione al server.");
          return;
        }

        if (res.status === 401) { await logout(); return; }
        if (res.status === 403 || res.status === 404) {
          alert("Accesso negato o foglio non trovato");
          window.location.href = "/app/mentalus/dashboard";
          return;
        }

        let data;
        try {
          data = await res.json();
        } catch (err) {
          console.error("Risposta non valida dal server:", err);
          alert("Errore: risposta inattesa dal server. Probabilmente sessione scaduta.");
          await logout();
          return;
        }

        if (!Array.isArray(data)) {
          console.error("Formato inatteso dei dati:", data);
          alert("Errore: formato dati inatteso dal server.");
          return;
        }

        paragraphList.innerHTML = '';
        data.forEach(p => {
          const li = document.createElement('li');
          li.className = "bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-sm flex justify-between items-start";

          // Contenitore del paragrafo
          const container = document.createElement('div');
          container.className = "flex-1 cursor-pointer";
          container.innerHTML = `<span class="text-slate-100">${p.descrizione}</span>`;
          container._clickHandler = () => {
            editParagraph(p.id, p.descrizione, container);
          };
          container.addEventListener('click', container._clickHandler);

          // Pulsante elimina
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = "Elimina";
          deleteBtn.className = "text-red-300 text-sm ml-4 hover:underline";
          deleteBtn.onclick = () => deleteParagraph(p.id);

          li.appendChild(container);
          li.appendChild(deleteBtn);
          paragraphList.appendChild(li);
        });
      } finally {
        stopLoading();
      }
    }

    let activeTextarea = null;

    function editParagraph(id, currentText, container) {
      const heightTextAreaView = container.offsetHeight;
      container.innerHTML = '';

      const lineCount = currentText.split('\n').length;
      const textarea = document.createElement('textarea');
      textarea.className = "w-full p-3 bg-slate-800 border border-slate-700 rounded-lg text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-400 resize-none";
      textarea.value = currentText;
      textarea.rows = lineCount;
      textarea.style.height = 'auto';
      textarea.style.minHeight = heightTextAreaView + 50 + 'px';

      container.appendChild(textarea);
      textarea.focus();
      activeTextarea = textarea;

      container.removeEventListener('click', container._clickHandler);

      const allowedElements = new Set([
        textarea,
        document.getElementById("boldBtn"),
        document.getElementById("italicBtn"),
        ...document.getElementById("boldBtn").querySelectorAll("*"),
        ...document.getElementById("italicBtn").querySelectorAll("*"),
      ]);

      // Scorciatoie
      textarea.addEventListener("keydown", (e) => {
        if ((e.ctrlKey || e.metaKey) && (e.key === "b" || e.key === "i")) {
          e.preventDefault();
          const tag = e.key === "b" ? "b" : "i";
          insertTagOnSelection(tag, textarea);
        }
      });

      const outsideClickHandler = async (e) => {
        if (![...allowedElements].some(el => el.contains(e.target))) {
          document.removeEventListener('mousedown', outsideClickHandler);
          activeTextarea = null;

          const newValue = sanitizeHTML(textarea.value);
          const form = new FormData();
          form.append('id', id);
          form.append('descrizione', newValue);

          await withLoader(async () => {
            await fetch('/app/mentalus/api/paragraphs.php?action=edit', {
              method: 'POST',
              credentials: 'include',
              body: form
            });
            await loadParagraphs();
          });
        }
      };

      document.addEventListener('mousedown', outsideClickHandler);
    }

    async function deleteParagraph(id) {
      const form = new FormData();
      form.append('id', id);

      await withLoader(async () => {
        await fetch('/app/mentalus/api/paragraphs.php?action=remove', {
          method: 'POST',
          credentials: 'include',
          body: form
        });
        await loadParagraphs();
      });
    }

    document.getElementById('paragraphForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const input = document.getElementById("descrizioneInput");
      let value = input.value;

      value = sanitizeHTML(value);

      const form = new FormData();
      form.append('descrizione', value);
      form.append('sheet_id', sheetId);

      await withLoader(async () => {
        await fetch('/app/mentalus/api/paragraphs.php?action=add', {
          method: 'POST',
          credentials: 'include',
          body: form
        });
        input.value = "";
        await loadParagraphs();
      });
    });

    document.getElementById("descrizioneInput").addEventListener("keydown", function(e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        document.getElementById("paragraphForm").requestSubmit();
      }

      if ((e.ctrlKey || e.metaKey) && (e.key === "b" || e.key === "i")) {
        e.preventDefault();

        const input = e.target;
        const start = input.selectionStart;
        const end = input.selectionEnd;
        const selectedText = input.value.substring(start, end);
        if (!selectedText) return;

        const tag = e.key === "b" ? "b" : "i";
        const before = input.value.substring(0, start);
        const after = input.value.substring(end);
        const replaced = `<${tag}>${selectedText}</${tag}>`;

        input.value = before + replaced + after;

        const newCursor = before.length + replaced.length;
        input.setSelectionRange(newCursor, newCursor);
      }
    });

    document.getElementById("descrizioneInput").addEventListener("paste", async (e) => {
      const clipboard = e.clipboardData || window.clipboardData;
      const pastedText = clipboard.getData('text');
      const paragraphs = pastedText.split(/\n\s*\n/).map(p => p.trim()).filter(Boolean);

      if (paragraphs.length <= 1) return;

      e.preventDefault();

      await withLoader(async () => {
        for (const paragraph of paragraphs) {
          const value = sanitizeHTML(paragraph);

          const form = new FormData();
          form.append('descrizione', value);
          form.append('sheet_id', sheetId);

          await fetch('/app/mentalus/api/paragraphs.php?action=add', {
            method: 'POST',
            credentials: 'include',
            body: form
          });
        }

        document.getElementById("descrizioneInput").value = "";
        await loadParagraphs();
      });
    });

    function sanitizeHTML(str) {
      // Mantieni solo <b> e <i>, rimuovi il resto
      return str
        .replace(/<(?!\/?(b|i)\b)[^>]*>/gi, "")
        .replace(/</g, "<")
        .replace(/>/g, ">");
    }

    function debounce(fn, delay) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    document.getElementById("boldBtn").addEventListener("click", () => {
      insertTagOnSelection("b", activeTextarea);
    });

    document.getElementById("italicBtn").addEventListener("click", () => {
      insertTagOnSelection("i", activeTextarea);
    });

    function insertTagOnSelection(tag, target) {
      const input = target || document.getElementById("descrizioneInput");
      const start = input.selectionStart;
      const end = input.selectionEnd;
      const selectedText = input.value.substring(start, end);
      if (!selectedText) return;

      const before = input.value.substring(0, start);
      const after = input.value.substring(end);
      const wrapped = `<${tag}>${selectedText}</${tag}>`;

      input.value = before + wrapped + after;
      input.focus();
      input.setSelectionRange(before.length + wrapped.length, before.length + wrapped.length);
    }

    // Avvio: mostra loader finché titolo + paragrafi non sono pronti
    withLoader(Promise.all([loadSheetTitle(), loadParagraphs()]));
  </script>
</body>
</html>