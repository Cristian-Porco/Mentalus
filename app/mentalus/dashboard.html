<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>I miei fogli di testo - Mentalus</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <div class="max-w-7xl mx-auto py-10 px-6">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-3xl font-bold text-gray-800">Mentalus</h2>
      <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Logout</button>
    </div>

    <!-- Aggiungi Foglio -->
    <form id="addForm" class="flex gap-4 mb-6">
      <input type="text" name="titolo" placeholder="Nuovo titolo" required
        class="flex-grow p-3 border rounded-md focus:outline-none focus:ring focus:ring-blue-300" />
      <button type="submit"
        class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition">Aggiungi</button>
    </form>

    <!-- Filtro categoria -->
    <div class="mb-6">
      <label for="categoryFilter" class="block text-sm font-medium text-gray-700 mb-1">Filtra per categoria:</label>
      <select id="categoryFilter" class="border p-2 rounded-md w-full max-w-sm">
        <option value="">Tutte le categorie</option>
      </select>
    </div>

    <h2 class="text-xl font-bold mb-3">I miei fogli di testo</h2>
    <div id="sheetList" class="space-y-3"></div>
  </div>

  <!-- Modale Elimina -->
  <div id="modal-overlay" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 flex">
    <div class="bg-white rounded-lg p-6 w-80">
      <h3 class="text-lg font-semibold mb-4">Eliminare questo foglio?</h3>
      <div class="flex justify-end gap-4">
        <button id="modal-cancel" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Annulla</button>
        <button id="modal-confirm" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">Elimina</button>
      </div>
    </div>
  </div>

  <!-- Modale Categoria -->
  <div id="modal-category" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 flex">
    <div class="bg-white rounded-lg p-6 w-80">
      <h3 class="text-lg font-semibold mb-4">Modifica categoria</h3>
      <input id="modal-cat-input" type="text" class="w-full border p-2 rounded mb-4" placeholder="Nuova categoria" />
      <div class="flex justify-end gap-4">
        <button id="modal-cat-cancel" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Annulla</button>
        <button id="modal-cat-confirm" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Salva</button>
      </div>
    </div>
  </div>

  <script>
    let deleteTarget = null;
    let categoryTarget = null;

    document.getElementById("categoryFilter").addEventListener("change", () => {
      const cat = document.getElementById("categoryFilter").value;
      fetchSheets(cat);
    });

    async function fetchAllCategories() {
      const res = await fetch('/text_sheets.php?action=categories', { credentials: 'include' });
      const data = await res.json();
      const select = document.getElementById("categoryFilter");
      const current = select.value;

      select.innerHTML = `<option value="">Tutte le categorie</option>`;
      data.sort().forEach(cat => {
        const option = document.createElement("option");
        option.value = cat;
        option.textContent = cat;
        if (cat === current) option.selected = true;
        select.appendChild(option);
      });
    }

    async function fetchSheets(category = '') {
      const query = category ? `&category=${encodeURIComponent(category)}` : '';
      const res = await fetch(`/text_sheets.php?action=view${query}`, { credentials: 'include' });
      const data = await res.json();
      const container = document.getElementById("sheetList");
      container.innerHTML = "";

      for (const sheet of data) {
        const sheetDiv = document.createElement("div");
        sheetDiv.className = "bg-white rounded-lg shadow p-4";

        const header = document.createElement("div");
        header.className = "flex justify-between items-start";

        const titleBlock = document.createElement("div");
        const titleRow = document.createElement("div");
        titleRow.className = "flex items-center gap-2 flex-wrap";

        const link = document.createElement("a");
        link.href = `/app/mentalus/sheet.html?id=${sheet.id}`;
        link.className = "text-lg font-semibold text-blue-600 hover:underline";
        link.textContent = sheet.titolo;
        titleRow.appendChild(link);

        if (sheet.category) {
          const badge = document.createElement("span");
          badge.className = "text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-medium";
          badge.textContent = sheet.category;
          titleRow.appendChild(badge);
        }

        titleBlock.appendChild(titleRow);

        const date = new Date(sheet.data_creazione);
        const createdAt = document.createElement("p");
        createdAt.className = "text-sm text-gray-500";
        createdAt.textContent = `Creato il ${date.toLocaleDateString()} alle ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
        titleBlock.appendChild(createdAt);

        const menuWrapper = document.createElement("div");
        menuWrapper.className = "relative";

        const menuBtn = document.createElement("button");
        menuBtn.textContent = "â‹®";
        menuBtn.className = "text-gray-500 hover:text-gray-700 text-xl px-2 focus:outline-none";

        const dropdown = document.createElement("div");
        dropdown.className = "absolute right-0 mt-2 w-40 bg-white border rounded shadow-lg hidden z-20";
        dropdown.innerHTML = `
          <button class="block w-full text-left px-4 py-2 hover:bg-gray-100 text-sm" data-action="category">Categoria</button>
          <button class="block w-full text-left px-4 py-2 hover:bg-gray-100 text-sm text-red-600" data-action="delete">Elimina</button>
        `;

        menuBtn.onclick = () => dropdown.classList.toggle("hidden");

        dropdown.querySelector('[data-action="category"]').onclick = () => {
          categoryTarget = sheet;
          document.getElementById("modal-cat-input").value = sheet.category || '';
          document.getElementById("modal-category").classList.remove("hidden");
          dropdown.classList.add("hidden");
        };

        dropdown.querySelector('[data-action="delete"]').onclick = () => {
          deleteTarget = sheet;
          document.getElementById("modal-overlay").classList.remove("hidden");
          dropdown.classList.add("hidden");
        };

        menuWrapper.appendChild(menuBtn);
        menuWrapper.appendChild(dropdown);

        header.appendChild(titleBlock);
        header.appendChild(menuWrapper);
        sheetDiv.appendChild(header);
        container.appendChild(sheetDiv);
      }
    }

    async function logout() {
      await fetch('/logout.php', { credentials: 'include' });
      window.location.href = "index.html";
    }

    document.getElementById("addForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = new FormData(e.target);

      const res = await fetch('/text_sheets.php?action=add', {
        method: 'POST',
        body: form,
        credentials: 'include'
      });

      const data = await res.json();

      if (res.ok && data.id) {
        window.location.href = `/app/mentalus/sheet.html?id=${data.id}`;
      } else {
        alert("Errore durante la creazione del foglio.");
      }
    });

    document.getElementById("modal-confirm").addEventListener("click", async () => {
      if (!deleteTarget) return;
      const form = new FormData();
      form.append("id", deleteTarget.id);
      await fetch('/text_sheets.php?action=remove', {
        method: 'POST',
        credentials: 'include',
        body: form
      });
      document.getElementById("modal-overlay").classList.add("hidden");
      await fetchAllCategories();
      const current = document.getElementById("categoryFilter").value;
      fetchSheets(current);
    });

    document.getElementById("modal-cancel").addEventListener("click", () => {
      document.getElementById("modal-overlay").classList.add("hidden");
    });

    document.getElementById("modal-cat-confirm").addEventListener("click", async () => {
      if (!categoryTarget) return;
      const nuova = document.getElementById("modal-cat-input").value;
      const form = new FormData();
      form.append("id", categoryTarget.id);
      form.append("titolo", categoryTarget.titolo);
      form.append("category", nuova);
      await fetch('/text_sheets.php?action=edit', {
        method: 'POST',
        credentials: 'include',
        body: form
      });
      document.getElementById("modal-category").classList.add("hidden");
      await fetchAllCategories();
      const current = document.getElementById("categoryFilter").value;
      fetchSheets(current);
    });

    document.getElementById("modal-cat-cancel").addEventListener("click", () => {
      document.getElementById("modal-category").classList.add("hidden");
    });

    fetchAllCategories().then(() => {
      const current = document.getElementById("categoryFilter").value;
      fetchSheets(current);
    });
  </script>
</body>
</html>